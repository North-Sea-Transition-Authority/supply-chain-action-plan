kind: pipeline
type: docker
name: default

steps:

  - name: restore-cache
    image: drillster/drone-volume-cache
    volumes:
      - name: drone-cache
        path: /cache
    settings:
      restore: true
      mount:
        - ./node_modules
        # We can only mount volume caches into the working directory, so all steps which use Gradle must have
        # the GRADLE_USER_HOME environment variable pointing here.
        - ./gradle_cache
        - ./sonar_cache

  - name: fetch-fds-submodule
    image: alpine/git:v2.26.2
    commands:
      - echo "$${BITBUCKET_SSH_KEY}" > bitbucket_ssh_key
      - chmod 600 bitbucket_ssh_key
      - export GIT_SSH_COMMAND="ssh -i bitbucket_ssh_key -F /dev/null  -o UserKnownHostsFile=/dev/null -o StrictHostKeyChecking=no"
      - git submodule update --init --recursive
    environment:
      BITBUCKET_SSH_KEY:
        from_secret: bitbucket_ssh_key

  - name: build-frontend
    image: node:10
    commands:
      - cd fivium-design-system-core && npm install && npx gulp build && cd ..
      - npm install
      - npx gulp buildAll

  - name: build-backend
    image: eclipse-temurin:17-jdk
    environment:
      SONAR_TOKEN:
        from_secret: sonarcloud_token
    commands:
      - chmod +x gradlew
      - ./gradlew checkstyleMain test bootJar sonarqube

  - name: sync-reports
    image: alpine:3.16.0
    commands:
      - mkdir -p /var/webfiles/${DRONE_BUILD_NUMBER}
      - cp -r build/reports /var/webfiles/${DRONE_BUILD_NUMBER}
    volumes:
      - name: webfiles
        path: /var/webfiles
    when:
      status: [ success, failure ]

  - name: publish-docker-develop
    image: plugins/docker:19.03.8
    settings:
      registry: quay.io
      repo: quay.io/fivium/supply-chain-action-plan
      tags:
        - develop
      config:
        from_secret: docker_config
    when:
      branch:
        - develop
      status:
        - success

  - name: publish-docker
    image: plugins/docker:19.03.8
    settings:
      registry: quay.io
      repo: quay.io/fivium/supply-chain-action-plan
      tags:
        - ${DRONE_BRANCH/\//-}-${DRONE_BUILD_NUMBER}
      config:
        from_secret: docker_config
    when:
      branch:
        - main
        - hotfix/**
        - release/**
      status:
        - success

  - name: trivy-build-image
    image: docker:20.10.9
    volumes:
      - name: docker-sock
        path: /var/run/docker.sock
    commands:
      - docker build -t quay.io/fivium/scap:trivy-scan-target .

  - name: trivy-scan
    image: aquasec/trivy:0.20.0
    volumes:
      - name: docker-sock
        path: /var/run/docker.sock
      - name: drone-trivy-cache
        path: /root/trivy-cache
      - name: webfiles
        path: /var/webfiles
    commands:
      # timeout set as initial cache population can seemingly take a while sometimes
      - trivy --format template --template "@contrib/html.tpl" -o /var/webfiles/${DRONE_BUILD_NUMBER}/trivy-scan.html image --timeout 30m --exit-code 1 quay.io/fivium/scap:trivy-scan-target
    when:
      status:
        - success

  - name: deploy-dev-st
    image: plugins/downstream:linux-amd64
    settings:
      server: https://drone.fivium.co.uk
      token:
        from_secret: drone_token
      fork: true
      repositories:
        - fiviumuk/fivium-dev-app@master
    when:
      branch:
        - develop
      status:
        - success

  - name: rebuild-cache
    image: drillster/drone-volume-cache
    volumes:
      - name: drone-cache
        path: /cache
    settings:
      rebuild: true
      mount:
        - ./node_modules
        - ./gradle_cache
        - ./sonar_cache

  - name: slack
    image: plugins/slack
    settings:
      webhook: https://hooks.slack.com/services/UPDATE_WEBHOOK
      channel: oga-scap-builds
      template: "*{{build.status}}* <{{build.link}}|Commit {{truncate build.commit 7}} on {{build.branch}} by ${DRONE_COMMIT_AUTHOR_NAME}>\nReports published to: http://drone-assets.fivium.local:9090/scap/{{build.number}}/"
    when:
      status: [ success, failure ]

trigger:
  event:
    include:
    - push

volumes:
  - name: webfiles
    host:
      path: /home/fivium/www/supply-chain-action-plan

  - name: drone-cache
    host:
      path: /home/fivium/drone-cache

  - name: docker-sock
    host:
      path: /var/run/docker.sock

  - name: drone-trivy-cache
    host:
      path: /root/.cache/

---

kind: secret
name: docker_config
data: BUILD_SECRET
---

kind: secret
name: sonarcloud_token
data: BUILD_SECRET

---

kind: secret
name: bitbucket_ssh_key
data: unbHpBxZdf4dGlJ6PIZqWZYlAhDD91ksrlrTj4juSUeoF72iMFFaGLv14cihdJz9Q9Wlo7E10O11SEKh46c28AyYqS8u5P2jVqX8z9cY2wuyMXMHEXlWj0zUsEFxhTcdCOMNKREzKIRRj5dcKANLHHxBHN9+1CHv/VwfpRKGAe4Lo40i6/lplN2D9M1CO5vS+yLwjipfEbSYu+Z3SHtbEGjK7c97f0IGla40Mc9v/D1SFm5S0UiGgbXI9SMZ8EW6B+xS2Uv/iEADhoZFUkkwK4s5Mf9X9JlsBL2wimNxA8DBQqwn1avvMEPFMmT4WkHMIzhZsh3kd34J/aSLWdH/jNdB8wFOgZUIAApZjEdNaiskwlwZbSDPrCKevbp7U90NHraULhcA5Cy++bYIZ9f+8mfAFw0Sgvzt4VjwJiovE2JWH0PuXozn2h3OozCGvYwBkh3BHnEqicaewr1wCrLAzt75NGcnMzQgG7LvI/ivcSBxtBMLUpUt38lofQOlFDYhstAe2Xfh3qErmzag030bZvFrcbSaZdLYRUvKWvYvtiOL9jUpx6pTaM6Chrl+jw+RVXHxAylZiYomr5sfzQ6Z+ojF37sstft7r691hd28+91phrkHGj4wJEWA0VCqdne+au7hEv362qZicZlbmMUX/TsyGNEgK4tt7RTHd1Omr5PQ1UCkkMV99otTPc7fAWSkcw7G5RjFcAHIX8u+/UGAOReg57HmI3lgquQW2Dq+msO2taBnPVJTLh4KleDy9YnW4iZsGMKIukGnapz0J52cQez7YW3YLQ6KykZSr8akf28YfW20ltqU2qyfzAp4cXB6YEIXdBPnBQoZ5j1KSJ0Us4kQXCqguPrsPfgiuF84lV+qX4612Aglr2zx3UgciY5Av+WBIIicfA8OFtDZezH4X9kFWuBEJjGag+y1oa3xZlFO4gTubs1IrTMmDBDL7QcX/WL6OmXB9PLSs6ShYJ6DH885hijyhWO47Vwy2GEt432aIht6aqaCVcyUYXfoGgCyvwvVcZEZ93FZBcMRIGfcUrUIFBcPRYTihTa5tOZCSzWrDyKLJRYogD84PuOJB2i9U2RNn/3NcpeEGdGO+vMWlgq9LC75KndD5wkXYEn6qapLhLbsC525Pjl28TpiM6oWPnKHHEBI7Qu3gnZpquOoW4GWjePFltqP/d7lIj+HbZBJYq7aIItNpQ3p4oGlepVbRXnn0nTMY/ib4nb1mJ0+IGrmGay9hnLxG/mYCiQ90tcnXxxc+jmiUMPQrpkCVgpZKrDoFF2QOcRku5yqpQWK6d3kiPSTEBcpbV1f7jA0ZqrgJLbQhEPf6iJL1cC1Adat5cRyE87k0823mIaI54Bg39FBOh5CuCs2RR5lvyQweu8Ee+O9W3mQfAuriYkr7kEWgGKJUkIos0G2T6vei/3LD9cRhyd514+4/CqBGfFjPvkTN8kBjfK4vBPRrU79SaBJsY/3Nl7uOxkaPjGaTHxy2scKqH39bVkrTmYbdPonC30WsbcwQBkfBqMQfkgQt2/bQ0tvVR+NeFJVURrO4SCdFtH2SkeJvwBm64mjr8FaytL1eMfL8nPKPDyrOzTza7byA5t/Bs/r/+bZ8auKAg6o/wob8wgq93VhElIW0/wmsLPQ0jBAe5I3kGCRsCvfGaik1LQq187ThAHgM00YkU8HPfwNlvBNyyg6ssLVg+4iC0ZBd9JNXW4q/4SmdDTGLIWInssJcH68BhlC5YURVkBy9VzTT0ai1VJz3wKUBVc0UuD+I668RBdfZTnfCn2JEIXCcRWHDJJWyI/5D4caGIQuRmAV30Fb2EpR0TTQwnwOhXOxiGHJmaf8MGz4I0u3yEmYe6NJlg/ydRPNP2EFYJU2S+Srilxzo7kipHBprRXrt6uvEw0ZyPX3qYII9elTqwBt+Thowu3jWUQFUs+G+X2BpUCGZwGx28gzwvXMQ1Ap/MzU/fqhWnMFp0/deK3f9XQvtTEhV/ZlszlodhSx40QcwKpXN2J/LgsRSeyq1h113CuoP48sA3CnI+2/kZfQpWf8WLYYz34cOnIZw0d9Q7ZAuqin+1kpgcwPhuA7+5HkujFoFh1K2M5UU0d/J32mefftqmLSgSDT037j5g/EM47nnju5jKR9Tllxclzfap/oNR4nVWfUkqquhtTohTFtLLGpLMAUOSuq0o65zTGgSm8Pd5lWmCeDeCICV8Wsy4i2wQ6jJ3tYd9oTw8jdajVZxXutSgwy4LLTLTgYcstw9oj2QJ3L7LLjyCeBwIi1bgXllM33Ig3BykwXWFUFQhNo2y2xSfbwiQAVsP2HKRVHvurRSyUaQJDCcKQV1yfI+ulX7rEeV4u/ARCMkTzIM+EXIDa8Iwmwarh/x7G539oL486vT8aU5TRJf/iJpJzC26BLlUXjaHTyCVAS1cwb+JkKBBq8fWAOig7k6lAEy2a6YS6KhhQsN2KEvVn0nZka3ycFfi3aEiuJzj/a10WtzWxv9EMkyC3t3Aw1gM5z8bfcqjcKdhcaWHRfPKPF/q6ybSw6xwuSa/qmfyPBGaQENJCCEpRxGBEOb1yf6uXuEgjYv1lkFXKDH7IV6uATxGk/UM49ybE3dRMFArvqQeLqtOXFrntAwVUFtpp0ST+APLq/9hf96k9hsaoP9ZWZ4L3MlHzKRA63fn2WMA+zxZNiGQ013ffYPcj+B6HNj4u+UjYuUU2dsXKk76mTXTPWcuM9HLGtDax+fub1zG5H+fkyzMTMWbz/f1a8ZkKShcI7L6piSchq9EcEPzhOIo4cvJ2p7QZXD2XwjDvT7Vhi9ZOIw91znpLL7sq6a+ZZjIBINQUkZcNkEw9NDpc/oAcpQRW0GROz+JTIDe/PW16J3YgycTgdnJRQK4UygRnBlFM9n0Q9a68Wub8PY/ERcpK762dr5Q2+AukfnDtOFhLHRNeWlHhqjZRISwuDYmQFP64ZU7o6i4Qn2qG94qW9DGLkdR+5sEdZ1avTiK4N76PHLYFHm/Mk/lrcsShkk9lYLHY0ZH3GP+L6iBJPF6i7tBnAfkbs6pmrVrZR7sxS5DHITZFCJCexqS+2N2WYJl2ShghmFd/AZZWojlLu5kvFeb+2XOGLqwvxh/Vaeyo4G1E7PtnW2ElAIBZRzpmNnIx9EOKvwXxAs5e2VC+iyi2IyqgrtRsxTbQziagOPWIPfpPQMNavRD6sEHefi9UP6XWUiXYtBvrojhxV1DniNaQ7NuzJ/ibfZpI3ffTtVi/bQyqPOuXQcumr1XvWElFY8mANV3bEqlafuaZuE18/+5tjxG9yI4a81nfwvB7YYIYrn5Y9W+72AIrRdSaNx44vPb5Mgb+/yMIquDiqTwVnFc0aukaqvNGn10MEvJNqKppnj1YnYH5bjofKYMzNSnLH5mCxPLlvvqbAvR/qzV8wJYSdgn5u3PvSzb+FTne/Ufs2Eycez2idYhDssTDvIW6APx1koJRaTAUkSJtgdvy/n/rHOLAUQ+rQ0HOU0X9SHoJqjae7v8KXBfm4xNjNmXo2n0Ez8BpJtsgoQYl9fHwQr9be8KuNnBFfiQ==

---

kind: secret
name: drone_token
data: BUILD_SECRET